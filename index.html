<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="K√ºt√ºphanem">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3389/3389081.png">
    <title>K√ºt√ºphanemPro</title>
    <style>
        /* --- TEMA --- */
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --header-footer-bg: rgba(28, 28, 30, 0.98);
            --text-main: #ffffff;
            --text-dim: #98989d;
            --accent: #0a84ff;
            --success: #32d74b;
            --warning: #ffd60a;
            --danger: #ff453a;
            --library: #ff9f0a;
            --user-book: #64d2ff;
            --border-color: rgba(255, 255, 255, 0.12);
            --bar-height: 60px;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-color); margin: 0; padding: 0; color: var(--text-main); -webkit-tap-highlight-color: transparent; padding-top: calc(var(--bar-height) + env(safe-area-inset-top)); padding-bottom: calc(var(--bar-height) + 20px + env(safe-area-inset-bottom)); overflow-x: hidden; }
        input, button, textarea { outline: none; font-family: inherit; }
        .hidden { display: none !important; }
        .header { position: fixed; top: 0; left: 0; right: 0; height: var(--bar-height); background-color: var(--header-footer-bg); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color); z-index: 100; display: flex; align-items: center; justify-content: center; padding-top: env(safe-area-inset-top); }
        .header h1 { margin: 0; font-size: 18px; font-weight: 600; }
        .content-area { padding: 20px; max-width: 600px; margin: 0 auto; min-height: 80vh; }
        .count-header { text-align: center; font-size: 13px; color: var(--text-dim); margin-top: -10px; margin-bottom: 15px; font-weight: 500; letter-spacing: 0.5px; }
        
        .input-std { width: 100%; height: 50px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 0 15px; color: white; font-size: 16px; box-sizing: border-box; margin-bottom: 12px; transition: 0.3s; }
        .input-std:focus { border-color: var(--accent); }
        textarea.input-std { height: 100px; padding-top: 15px; resize: none; }
        
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .btn-main { width: 100%; height: 50px; background: var(--accent); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-outline { width: 100%; height: 50px; background: transparent; color: var(--accent); border: 1px solid var(--accent); border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .btn-small { height: 35px; font-size: 12px; padding: 0 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: white; cursor: pointer; flex: 1; white-space: nowrap; transition: 0.2s; }
        .btn-small.active-filter { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-small.active-filter[data-type="added"] { background: var(--user-book); border-color: var(--user-book); color: black; }
        .btn-icon { width: 50px; height: 50px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-dim); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px;}

        /* Kitap Kartƒ± */
        .book-item { display: flex; align-items: center; padding: 12px; margin-bottom: 10px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); cursor: pointer; position: relative; transition: all 0.3s ease; }
        .book-item.just-added { animation: highlightNew 2s ease-out; }
        @keyframes highlightNew { from { background: var(--accent); } to { background: var(--card-bg); } }
        .book-icon-box { width: 45px; height: 68px; border-radius: 6px; overflow: hidden; margin-right: 15px; flex-shrink: 0; position: relative; }
        .book-icon-box img { width: 100%; height: 100%; object-fit: cover; }
        .default-cover { width: 100%; height: 100%; background: linear-gradient(135deg, #2c2c2e 0%, #1a1a1a 100%); display: flex; align-items: center; justify-content: center; font-size: 24px; color: #fff; }
        .book-details { flex: 1; overflow: hidden; }
        .book-title { font-size: 15px; font-weight: 600; color: white; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-author { font-size: 13px; color: var(--text-dim); }
        .status-badge { position:absolute; bottom:12px; right:12px; width:10px; height:10px; border-radius:50%; display:none; }
        .status-badge.show { display:block; }
        .owner-badge { position: absolute; top: 12px; right: 12px; font-size: 10px; padding: 3px 6px; border-radius: 6px; font-weight: bold; color: #000; text-transform: uppercase; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .owner-badge.library { background: var(--library); }
        .owner-badge.user { background: var(--user-book); }
        .owner-badge.pending { background: #ff453a; color: white; }
        .pending-item { background: rgba(255, 159, 10, 0.1); border: 1px solid var(--library); padding: 10px; border-radius: 10px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .pending-badge { background: var(--library); color: black; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; inset: 0; background: var(--bg-color); z-index: 2000; overflow-y: auto; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { position: sticky; top: 0; background: var(--header-footer-bg); height: var(--bar-height); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid var(--border-color); padding-top: env(safe-area-inset-top); z-index: 10; }
        .modal-body { padding: 25px 20px; max-width: 600px; margin: 0 auto; padding-bottom: 100px; text-align: center; }
        .btn-nav { background: none; border: none; color: var(--accent); font-size: 16px; font-weight: 400; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .minimal-stat-bar { display: flex; align-items: center; justify-content: center; gap: 15px; font-size: 13px; color: var(--text-dim); margin-bottom: 15px; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .minimal-stat-bar span { display: flex; align-items: center; gap: 4px; }
        .minimal-stat-bar strong { color: white; }
        .compact-actions { display: flex; gap: 8px; margin-bottom: 20px; }
        .btn-compact { flex: 1; height: 40px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: white; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; }
        .btn-compact.active-read { background: rgba(50, 215, 75, 0.15); color: var(--success); border-color: var(--success); }
        .btn-compact.active-want { background: rgba(10, 132, 255, 0.15); color: var(--accent); border-color: var(--accent); }
        .social-stats { display: flex; justify-content: center; gap: 15px; margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; }
        .stat-item { font-size: 11px; color: var(--text-dim); display: flex; flex-direction: column; align-items: center; }
        .stat-val { font-size: 18px; font-weight: bold; color: white; margin-bottom: 2px; }

        .author-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px; }
        .author-card { background: var(--card-bg); padding: 20px 10px; border-radius: 16px; text-align: center; border: 1px solid var(--border-color); cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: 0.2s; }
        .author-card:active { transform: scale(0.98); }
        .author-img-box { width: 80px; height: 80px; border-radius: 50%; background: #333; margin-bottom: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 2px solid var(--border-color); font-size: 28px; color: #ccc; }
        .author-img-box img { width: 100%; height: 100%; object-fit: cover; }
        .author-detail-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        .author-detail-img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent); margin-bottom: 15px; background: #333; }
        .author-detail-bio { font-size: 13px; color: #ccc; line-height: 1.5; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: left; }

        .star-rating-minimal { display: flex; justify-content: center; gap: 5px; margin-bottom: 15px; }
        .star { font-size: 24px; color: #444; cursor: pointer; transition: 0.2s; } .star.filled { color: var(--warning); }
        .user-row { display: flex; align-items: center; justify-content: space-between; padding: 15px; background: var(--card-bg); border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 5px; border-radius: 10px; cursor: pointer; }
        .user-info { display: flex; flex-direction: column; align-items: flex-start; }
        .user-role-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #333; color: #aaa; margin-top: 3px; font-weight: 600; }
        .user-role-badge.admin { background: rgba(10,132,255,0.2); color: var(--accent); }
        .user-role-badge.super { background: linear-gradient(45deg, #ffd700, #ffa500); color: #000; box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
        .btn-user-action { height: 30px; font-size: 11px; padding: 0 10px; border-radius: 6px; border:none; cursor: pointer; color:white; margin-left: 5px;}
        .toggle-switch-compact { display: flex; align-items: center; justify-content: center; gap: 10px; background: transparent; padding: 5px; margin-bottom: 15px; }
        .switch-sm { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch-sm input { opacity: 0; width: 0; height: 0; }
        .slider-sm { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider-sm:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider-sm { background-color: var(--accent); }
        input:checked + .slider-sm:before { transform: translateX(14px); }
        .msg-item { background: var(--card-bg); border: 1px solid var(--border-color); padding: 15px; border-radius: 10px; margin-bottom: 10px; text-align: left; }
        .msg-header { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-dim); margin-bottom: 5px; }
        .comment-row { border-bottom: 1px solid #333; padding: 10px 0; text-align: left; position: relative; }
        .comment-user { color: var(--accent); font-size: 12px; font-weight: bold; margin-bottom: 2px; }
        .comment-text { font-size: 13px; color: #ddd; line-height: 1.4; padding-right: 25px; }
        .comment-del { position: absolute; right: 0; top: 10px; color: #666; cursor: pointer; padding: 5px; }
        .comment-del:hover { color: var(--danger); }
        .my-comment-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; margin-bottom: 10px; display: flex; gap: 12px; align-items: flex-start; cursor: pointer; text-align: left; }
        .my-comment-cover { width: 35px; height: 50px; border-radius: 4px; object-fit: cover; flex-shrink: 0; }
        .my-comment-info { flex: 1; }
        .my-comment-book { font-weight: 600; font-size: 14px; color: white; margin-bottom: 2px; }
        .my-comment-date { font-size: 10px; color: var(--text-dim); margin-bottom: 4px; }
        .my-comment-body { font-size: 12px; color: #ccc; line-height: 1.3; }

        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: var(--bar-height); background-color: var(--header-footer-bg); backdrop-filter: blur(20px); border-top: 1px solid var(--border-color); z-index: 100; display: flex; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom); }
        .tab-btn { background: none; border: none; padding: 0; color: var(--text-dim); flex: 1; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .tab-btn.active { color: var(--accent); } .tab-btn span { font-size: 10px; font-weight: 600; margin-top: 4px; }
        .icon { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        
        .badge-dot { position: absolute; top: 8px; right: 30%; width: 10px; height: 10px; background-color: var(--danger); border-radius: 50%; border: 2px solid var(--header-footer-bg); display: none; }

        /* YENƒ∞ EƒûLENCELƒ∞ POP-UP (Fun Modal) STƒ∞LLERƒ∞ */
        .fun-modal { display: none; position: fixed; inset: 0; z-index: 3000; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); align-items: center; justify-content: center; animation: fadeIn 0.3s; }
        .fun-card { background: linear-gradient(145deg, #1c1c1e, #2c2c2e); border: 2px solid var(--accent); width: 85%; max-width: 350px; border-radius: 20px; padding: 25px; text-align: center; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.7); transform: scale(0.9); animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { to { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fun-emoji { font-size: 40px; margin-bottom: 10px; animation: bounce 2s infinite; display: inline-block; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }
        .fun-cover { width: 140px; height: 210px; border-radius: 10px; object-fit: cover; margin: 15px auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.1); }
        .fun-title { font-size: 18px; font-weight: bold; color: white; margin-bottom: 5px; }
        .fun-author { font-size: 14px; color: var(--text-dim); margin-bottom: 20px; }
        .fun-actions { display: flex; gap: 10px; }
        .btn-fun { flex: 1; height: 45px; border-radius: 12px; border: none; font-weight: bold; font-size: 14px; cursor: pointer; color: white; }
        .btn-fun-add { background: var(--accent); }
        .btn-fun-view { background: rgba(255,255,255,0.1); color: #ccc; }
        .btn-close-fun { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #666; font-size: 20px; cursor: pointer; }

        #toast-container { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 300px; text-align: center; pointer-events: none; }
        .toast { background: rgba(50,50,50,0.95); backdrop-filter: blur(10px); color: white; padding: 12px 20px; border-radius: 30px; font-size: 14px; margin-bottom: 10px; opacity: 0; transform: translateY(-20px) scale(0.9); transition: all 0.3s; display: inline-block; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); font-weight: 600;}
        .toast.show { opacity: 1; transform: translateY(0) scale(1); }
    </style>
</head>
<body>

    <div id="toast-container"></div>
    <div class="header"><h1>K√ºt√ºphanem</h1></div>

    <div id="page-library" class="content-area">
        <div style="margin-bottom:20px; display:flex; gap:10px;">
            <input type="text" id="search-input" class="input-std" style="margin:0;" placeholder="Kitap veya yazar ara..." onkeyup="applyFilters()">
            <button class="btn-icon" onclick="toggleSort()" id="btn-sort" title="Sƒ±rala">‚áÖ</button>
        </div>
        <div id="count-books" class="count-header">Y√ºkleniyor...</div>
        <div id="book-list"></div>
    </div>

    <div id="page-authors" class="content-area hidden">
        <div style="margin-bottom:20px;">
            <input type="text" id="search-authors" class="input-std" style="margin:0;" placeholder="Yazar ara..." onkeyup="renderAuthors()">
        </div>
        <div id="count-authors" class="count-header" style="margin-top:10px;">Y√ºkleniyor...</div>
        <div id="authors-grid" class="author-grid"></div>
    </div>

    <div id="page-users" class="content-area hidden">
        <h2 style="margin-bottom:0; text-align: center;">Okurlar (Y√∂netim)</h2>
        <div id="count-users" class="count-header" style="margin-top:5px; margin-bottom:20px;">Y√ºkleniyor...</div>
        <div id="users-list"></div>
    </div>

    <div id="page-auth" class="content-area hidden" style="display:flex; flex-direction:column; justify-content:center; min-height:80vh; text-align:center;">
        <div style="font-size:60px; margin-bottom:20px;">ü¶â</div>
        <h2 id="auth-title">Giri≈ü Yap</h2>
        <p style="color:#999; font-size:13px; margin-bottom:20px;">Kitap eklemek ve etkile≈üim i√ßin giri≈ü yapmalƒ±sƒ±n.</p>
        <input type="email" id="auth-email" class="input-std" placeholder="E-posta">
        <input type="password" id="auth-pass" class="input-std" placeholder="≈ûifre">
        <button class="btn-main" onclick="handleAuth()" id="btn-auth">Giri≈ü Yap</button>
        <div style="margin-top:15px; display:flex; flex-direction:column; gap:10px;">
            <span onclick="resetPass()" style="color:var(--accent); font-size:14px; cursor:pointer;">≈ûifremi Unuttum</span>
            <span onclick="toggleAuthMode()" style="color:var(--text-dim); font-size:14px; cursor:pointer;">Hesabƒ±n yok mu? Kayƒ±t Ol</span>
        </div>
    </div>

    <div id="page-profile" class="content-area hidden" style="text-align:center;">
        <div style="width:100px; height:100px; margin: 20px auto 10px; background:#333; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:40px;">üë§</div>
        <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
            <h2 id="profile-name" style="margin:5px 0;">Kullanƒ±cƒ±</h2>
            <span onclick="toggleNameEdit()" style="cursor:pointer; font-size:16px; color:var(--accent); opacity:0.8;">‚úèÔ∏è</span>
        </div>
        <p id="profile-email" style="color:var(--text-dim); font-size:13px; margin-top:0;">mail@mail.com</p>
        <div id="profile-role-badge" style="color:var(--accent); font-size:12px; margin-bottom:10px; font-weight:bold;"></div>
        
        <div id="name-edit-area" class="hidden" style="margin-bottom:15px; animation: slideUp 0.2s;">
            <div style="display:flex; gap:5px; justify-content:center; max-width:250px; margin:0 auto;">
                <input type="text" id="new-username" class="input-std" placeholder="Yeni ƒ∞sim" style="margin:0; height:35px; font-size:14px;">
                <button onclick="updateUserProfile()" class="btn-main" style="width:auto; height:35px; font-size:13px; padding:0 15px;">Kaydet</button>
            </div>
        </div>

        <button class="btn-outline" style="border-color:var(--success); color:var(--success); margin-bottom:15px;" onclick="recommendBook()">üé≤ Bana Kitap √ñner</button>
        
        <div class="social-stats">
            <div class="stat-item"><span class="stat-val" id="stat-read">0</span>OKUDUM</div>
            <div class="stat-item"><span class="stat-val" id="stat-want">0</span>Lƒ∞STEMDE</div>
            <div class="stat-item"><span class="stat-val" id="stat-added" style="color:var(--user-book);">0</span>EKLEDƒ∞M</div>
            <div class="stat-item"><span class="stat-val" id="stat-com">0</span>YORUM</div>
        </div>

        <div style="display:flex; justify-content: center; gap:5px; margin-bottom: 20px;">
             <button class="btn-small profile-filter-btn" id="btn-filter-read" onclick="filterProfile('read')">Okuduklarƒ±m</button>
             <button class="btn-small profile-filter-btn" id="btn-filter-want" onclick="filterProfile('want')">Listem</button>
             <button class="btn-small profile-filter-btn" id="btn-filter-added" onclick="filterProfile('added')" data-type="added">Eklediklerim</button>
             <button class="btn-small profile-filter-btn" id="btn-filter-comments" onclick="filterProfile('comments')">Yorumlarƒ±m</button>
        </div>
        <div id="profile-list" style="text-align:left; margin-bottom:30px;"></div>
        
        <div style="border-top:1px solid #333; padding-top:20px; display:flex; flex-direction:column; gap:10px;">
            <button class="btn-outline" style="border-color:#444; color:#ccc;" onclick="document.getElementById('pass-change-area').classList.toggle('hidden')">üîë ≈ûifre Deƒüi≈ütir</button>
            <div id="pass-change-area" class="hidden" style="background:#2c2c2e; padding:15px; border-radius:10px;">
                <input type="password" id="new-pass" class="input-std" placeholder="Yeni ≈ûifre" style="height:40px; font-size:14px;">
                <button class="btn-main" style="height:40px;" onclick="changePass()">G√ºncelle</button>
            </div>
            <button onclick="logout()" class="btn-main" style="background:var(--danger); margin-top:10px;">√áƒ±kƒ±≈ü Yap</button>
        </div>
    </div>

    <div id="page-add" class="content-area hidden">
        <h2 style="margin-bottom:20px;">Kitap Ekle</h2>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input type="number" id="isbn-input" class="input-std" style="margin:0;" placeholder="Barkod (ISBN)" inputmode="numeric" pattern="[0-9]*">
            <button onclick="fetchByISBN()" class="btn-main" style="width:60px; margin:0;">üîç</button>
        </div>
        <input type="text" id="add-title" class="input-std" placeholder="Kitap Adƒ±">
        <input type="text" id="add-author" class="input-std" placeholder="Yazar Adƒ±">
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input type="text" id="add-cover" class="input-std" placeholder="Kapak Linki" style="margin:0;">
            <button onclick="findCoverFromText()" class="btn-main" style="width:60px; margin:0;" title="Kapak Bul">üñºÔ∏è</button>
        </div>
        <textarea id="add-desc" class="input-std" placeholder="√ñzet"></textarea>
        
        <button id="btn-save-book" onclick="adminAddBook()" class="btn-main">Onaya G√∂nder</button>

        <div id="admin-tools-area" class="hidden" style="border-top:1px solid var(--border-color); padding-top:20px; margin-top:30px;">
            <div style="font-size:12px;color:var(--text-dim);text-transform:uppercase;margin-bottom:15px;">Y√ñNETƒ∞Cƒ∞ ARA√áLARI</div>
            <div id="pending-container" style="margin-bottom:20px;">
                <div style="font-size:13px; color:var(--library); margin-bottom:10px;">‚è≥ Onay Bekleyen Kitaplar</div>
                <div id="pending-list" style="background:#111; padding:10px; border-radius:10px; min-height:50px;">
                    <div style="color:#666; font-size:12px; text-align:center;">Bekleyen yok.</div>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <button class="btn-small" onclick="viewMessages()">üì© Mesajlar</button>
                <button class="btn-small" onclick="findDuplicates()">üßπ M√ºkerrerleri Bul</button>
                <button class="btn-small" style="background:#2ecc71; border-color:#2ecc71;" onclick="exportExcel()">üì§ Excel Olarak ƒ∞ndir</button>
                <button class="btn-small" onclick="autoFixMissing()">‚ö° Eksikleri Tara</button>
                <button class="btn-small" onclick="document.getElementById('file-import').click()">üìÇ Excel'den Y√ºkle</button>
            </div>
            <input type="file" id="file-import" style="display:none;" onchange="importData(this)" accept=".csv,.json">
        </div>
    </div>

    <div id="recommendation-modal" class="fun-modal">
        <div class="fun-card">
            <button class="btn-close-fun" onclick="closeRecommendation()">√ó</button>
            <div class="fun-emoji">‚ú®üé≤‚ú®</div>
            <h2 style="margin:0; font-size:16px; color:var(--accent);">G√ºn√ºn ≈ûanslƒ± Kitabƒ±</h2>
            <div id="fun-book-content"></div>
        </div>
    </div>

    <div id="full-modal" class="modal-overlay">
        <div class="modal-header">
            <button class="btn-nav" onclick="closeFullModal()"><svg class="icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg> Geri</button>
            <span id="modal-title" style="font-weight:600;">Detay</span>
            <button id="btn-edit-mode" class="btn-nav" onclick="toggleEditMode()" style="display:none;">D√ºzenle</button>
            <button id="btn-edit-auth-mode" class="btn-nav" onclick="toggleAuthorEditMode()" style="display:none;">D√ºzenle</button>
        </div>
        <div class="modal-body" style="text-align:center;">
            <div id="modal-view-mode"></div>
            <div id="modal-author-view-mode" class="hidden"></div>
            <div id="modal-edit-mode" class="hidden" style="text-align:left;">
                <div style="background:var(--library); color:black; padding:10px; border-radius:8px; margin-bottom:15px; font-size:12px; font-weight:bold; display:none;" id="edit-mode-warning">‚ö†Ô∏è Bu kitap hen√ºz onaylanmadƒ±. D√ºzenleyip onaylayabilirsiniz.</div>
                <label style="font-size:12px;color:#666;">Kitap Adƒ±</label><input type="text" id="edit-title" class="input-std">
                <label style="font-size:12px;color:#666;">Yazar</label><input type="text" id="edit-author" class="input-std">
                <label style="font-size:12px;color:#666;">Kapak</label><input type="text" id="edit-cover" class="input-std">
                <label style="font-size:12px;color:#666;">√ñzet</label><textarea id="edit-desc" class="input-std"></textarea>
                <div style="display:flex; gap:10px;">
                    <button onclick="saveEditedBook()" class="btn-main" style="flex:1;">Kaydet</button>
                    <button id="btn-approve-publish" onclick="approveBook()" class="btn-main" style="background:var(--success); flex:1; display:none;">‚úÖ Onayla ve Yayƒ±nla</button>
                </div>
                <button onclick="adminDeleteBook()" style="background:none; color:var(--danger); border:none; margin-top:15px; width:100%;">‚ùå Sil / Reddet</button>
            </div>
            <div id="modal-edit-auth-mode" class="hidden" style="text-align:left;">
                <label style="font-size:12px;color:#666;">Resim URL</label><input type="text" id="edit-auth-img" class="input-std">
                <label style="font-size:12px;color:#666;">Biyografi</label><textarea id="edit-auth-bio" class="input-std"></textarea>
                <button onclick="saveAuthorDetails()" class="btn-main">Kaydet</button>
            </div>
        </div>
    </div>

    <div class="tab-bar" id="main-tabs">
        <button class="tab-btn active" id="tab-library" onclick="switchTab('library')"><svg class="icon" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg><span>Kitaplƒ±k</span></button>
        <button class="tab-btn" id="tab-authors" onclick="switchTab('authors')"><svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg><span>Yazarlar</span></button>
        <button class="tab-btn hidden" id="tab-users" onclick="switchTab('users')"><svg class="icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg><span>Okurlar</span></button>
        <button class="tab-btn" id="tab-profile" onclick="switchTab('profile')"><svg class="icon" viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg><span>Profil</span></button>
        <button class="tab-btn hidden" id="tab-add" onclick="switchTab('add')">
            <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
            <span>Ekle</span>
            <div id="admin-badge" class="badge-dot"></div>
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, query, where, getDocs, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDL0V_O0pNKoffz9Hbiq0XS6r8-QgFSj4M",
          authDomain: "kutuphanempro.firebaseapp.com",
          projectId: "kutuphanempro",
          storageBucket: "kutuphanempro.firebasestorage.app",
          messagingSenderId: "1078423422176",
          appId: "1:1078423422176:web:615aff2996cf23d2087c85",
          measurementId: "G-MN418DNR6F"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const SUPER_ADMIN_EMAIL = "mete.serkanali@gmail.com";

        let currentUser = null;
        let isAdmin = false;
        let isLoginMode = true;
        
        let rawSnapshots = []; 
        let globalBooks = [];
        let pendingBooks = []; 
        let userInteractions = {};
        let myComments = []; 
        let authorMeta = {}; 
        let currentBook = null;
        let currentAuthorName = null; 
        let sortAsc = true; 
        const cleanText = (t) => t ? t.toString().toLowerCase().replace(/\s+/g, '').trim() : "";
        
        onSnapshot(collection(db, "books"), (snap) => { 
            rawSnapshots = [];
            snap.forEach(d => { rawSnapshots.push({id: d.id, ...d.data()}); });
            processBooks();
        });

        onSnapshot(collection(db, "authors"), (snap) => {
            authorMeta = {};
            snap.forEach(d => { authorMeta[d.id] = d.data(); });
            renderAuthors(); 
        });

        function processBooks() {
            globalBooks = [];
            pendingBooks = [];
            rawSnapshots.forEach(b => {
                const isActive = b.status === 'active' || !b.status;
                const isPending = b.status === 'pending';
                if (isActive) { globalBooks.push(b); } 
                else if (isPending) {
                    pendingBooks.push(b);
                    if (currentUser && b.addedBy === currentUser.uid) {
                        const myPendingBook = {...b, isMyPending: true}; 
                        globalBooks.push(myPendingBook);
                    }
                }
            });
            document.getElementById('count-books').innerText = `Toplam: ${globalBooks.length} Kitap`; 
            applyFilters(); renderAuthors(); 
            if(isAdmin) {
                renderPendingList(); 
                const badge = document.getElementById('admin-badge');
                if(pendingBooks.length > 0) badge.style.display = 'block';
                else badge.style.display = 'none';
            }
        }

        window.handleAuth = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            if(!email || !pass) return showToast("Bilgileri giriniz");
            try {
                let userCred;
                if(isLoginMode) { userCred = await signInWithEmailAndPassword(auth, email, pass); } 
                else { userCred = await createUserWithEmailAndPassword(auth, email, pass); await updateProfile(userCred.user, { displayName: "Okur" }); showToast("Kayƒ±t Ba≈üarƒ±lƒ±! Ho≈ü geldin üëã"); }
            } catch(e) { showToast("Hata: " + e.message); }
        }

        window.toggleAuthMode = () => { isLoginMode = !isLoginMode; document.getElementById('auth-title').innerText = isLoginMode ? "Giri≈ü Yap" : "Kayƒ±t Ol"; document.getElementById('btn-auth').innerText = isLoginMode ? "Giri≈ü Yap" : "Kayƒ±t Ol"; }
        window.logout = () => signOut(auth);
        window.resetPass = async () => { const email = prompt("E-posta adresini gir:"); if(email) { try { await sendPasswordResetEmail(auth, email); alert("Sƒ±fƒ±rlama baƒülantƒ±sƒ± g√∂nderildi!"); } catch(e) { alert("Hata: " + e.message); } } }
        window.changePass = async () => { const newP = document.getElementById('new-pass').value; if(!newP || newP.length < 6) return alert("≈ûifre en az 6 karakter olmalƒ±"); try { await updatePassword(currentUser, newP); alert("≈ûifre deƒüi≈üti!"); document.getElementById('new-pass').value=""; document.getElementById('pass-change-area').classList.add('hidden'); } catch(e) { alert("G√ºvenlik nedeniyle √ßƒ±kƒ±≈ü yapƒ±p tekrar girmelisin."); } }
        window.toggleNameEdit = () => { document.getElementById('name-edit-area').classList.toggle('hidden'); }
        window.updateUserProfile = async () => { const name = document.getElementById('new-username').value; if(!name) return; await updateProfile(currentUser, { displayName: name }); await updateDoc(doc(db, "users", currentUser.uid), { displayName: name }); document.getElementById('profile-name').innerText = name; window.toggleNameEdit(); showToast("ƒ∞sim g√ºncellendi ‚úÖ"); }
        // Gƒ∞ZLƒ∞Lƒ∞K BUTONU ARTIK YOK

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                const userRef = doc(db, "users", user.uid);
                let userSnap = await getDoc(userRef);
                const creationTime = new Date(user.metadata.creationTime).getTime();
                const isNewUser = (Date.now() - creationTime) < 10000; 
                if (!userSnap.exists()) {
                    if (isNewUser || user.email === SUPER_ADMIN_EMAIL) {
                        await setDoc(userRef, { email: user.email, role: 'user', isPrivate: false, createdAt: Date.now() });
                        userSnap = await getDoc(userRef); 
                    } else { await signOut(auth); alert("Hesabƒ±nƒ±z silinmi≈ü."); return; }
                }
                currentUser = user;
                let role = 'user'; let isPrivate = false;
                if(userSnap.exists()) { role = userSnap.data().role; isPrivate = userSnap.data().isPrivate || false; }
                if(user.email === SUPER_ADMIN_EMAIL) role = 'admin';
                isAdmin = (role === 'admin');
                
                document.getElementById('profile-email').innerText = user.email; document.getElementById('profile-name').innerText = user.displayName || "Okur"; 
                document.getElementById('profile-role-badge').innerText = isAdmin ? (user.email===SUPER_ADMIN_EMAIL ? "S√úPER ADMƒ∞N" : "Y√ñNETƒ∞Cƒ∞") : "√úYE";
                
                document.getElementById('tab-add').classList.remove('hidden'); 
                
                const usersTab = document.getElementById('tab-users');
                if(isAdmin) {
                    document.getElementById('admin-tools-area').classList.remove('hidden');
                    document.getElementById('btn-save-book').innerText = "Kaydet (Direkt Yayƒ±nla)";
                    usersTab.classList.remove('hidden'); 
                    renderPendingList();
                    listenToUsers();
                } else {
                    document.getElementById('admin-tools-area').classList.add('hidden');
                    document.getElementById('btn-save-book').innerText = "Onaya G√∂nder";
                    usersTab.classList.add('hidden'); 
                }
                
                processBooks(); listenToInteractions(); listenToUserComments();
                if(!document.getElementById('page-auth').classList.contains('hidden')) switchTab('profile'); else applyFilters();
            } else { 
                currentUser = null; isAdmin = false; userInteractions = {}; myComments = [];
                document.getElementById('tab-add').classList.add('hidden'); 
                document.getElementById('tab-users').classList.add('hidden'); 
                document.getElementById('admin-badge').style.display = 'none';
                processBooks(); applyFilters();
            }
        });

        window.renderAuthors = () => {
            const q = document.getElementById('search-authors').value.toLowerCase();
            const grid = document.getElementById('authors-grid');
            grid.innerHTML = "";
            const authors = {};
            globalBooks.forEach(b => {
                if(b.author.toLowerCase().includes(q)) {
                    if(!authors[b.author]) authors[b.author] = [];
                    authors[b.author].push(b);
                }
            });
            document.getElementById('count-authors').innerText = `Toplam: ${Object.keys(authors).length} Yazar`;
            Object.keys(authors).sort().forEach(authorName => {
                const count = authors[authorName].length;
                const meta = authorMeta[authorName] || {}; 
                const div = document.createElement('div');
                div.className = 'author-card';
                div.onclick = () => window.openAuthorDetail(authorName, authors[authorName]); 
                let imgContent = meta.img ? `<img src="${meta.img}">` : authorName.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
                div.innerHTML = `<div class="author-img-box">${imgContent}</div><div style="font-weight:bold; font-size:14px; margin-bottom:5px; color:white;">${authorName}</div><div style="font-size:12px; color:var(--text-dim);">${count} Kitap</div>`;
                grid.appendChild(div);
            });
        }

        window.openAuthorDetail = (authorName, books) => {
             currentAuthorName = authorName;
             const meta = authorMeta[authorName] || {};
             
             document.getElementById('modal-view-mode').classList.add('hidden');
             document.getElementById('modal-edit-mode').classList.add('hidden');
             document.getElementById('modal-edit-auth-mode').classList.add('hidden');
             document.getElementById('modal-author-view-mode').classList.remove('hidden');
             
             document.getElementById('modal-title').innerText = "Yazar Detayƒ±";
             document.getElementById('btn-edit-mode').style.display = 'none';
             document.getElementById('btn-edit-auth-mode').style.display = isAdmin ? 'block' : 'none';
             document.getElementById('btn-edit-auth-mode').innerText = "D√ºzenle";

             const imgUrl = meta.img || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
             const bioText = meta.bio || "Biyografi bulunamadƒ±.";

             const container = document.getElementById('modal-author-view-mode');
             let booksHtml = "";
             books.forEach(b => {
                 booksHtml += `<div style="display:flex; align-items:center; background:#2c2c2e; padding:10px; border-radius:10px; margin-bottom:10px; cursor:pointer;" onclick="openBookModalById('${b.id}')"><div style="width:30px; height:45px; background:#444; margin-right:10px; border-radius:4px; overflow:hidden;">${b.cover ? `<img src="${b.cover}" style="width:100%; height:100%; object-fit:cover;">` : ''}</div><div style="flex:1; text-align:left;"><div style="font-size:14px; color:white; font-weight:600;">${b.title}</div><div style="font-size:11px; color:#aaa;">${b.desc ? b.desc.substring(0,40)+'...' : ''}</div></div></div>`;
             });

             container.innerHTML = `<div class="author-detail-header"><img src="${imgUrl}" class="author-detail-img"><h2 style="margin:0;">${authorName}</h2></div><div class="author-detail-bio"><strong>Biyografi:</strong><br>${bioText}</div><h4 style="text-align:left; margin-bottom:10px; color:var(--accent);">Eserleri (${books.length})</h4><div style="display:block;">${booksHtml}</div>`;
             document.getElementById('full-modal').style.display = 'block';
        }
        
        window.openBookModalById = (id) => { const book = globalBooks.find(b => b.id === id); if(book) openBookModal(book); }

        window.toggleAuthorEditMode = () => {
             const view = document.getElementById('modal-author-view-mode');
             const edit = document.getElementById('modal-edit-auth-mode');
             if(view.classList.contains('hidden')) {
                 view.classList.remove('hidden'); edit.classList.add('hidden'); document.getElementById('btn-edit-auth-mode').innerText = "D√ºzenle";
             } else {
                 view.classList.add('hidden'); edit.classList.remove('hidden'); document.getElementById('btn-edit-auth-mode').innerText = "ƒ∞ptal";
                 const meta = authorMeta[currentAuthorName] || {};
                 document.getElementById('edit-auth-img').value = meta.img || "";
                 document.getElementById('edit-auth-bio').value = meta.bio || "";
             }
        }
        
        window.saveAuthorDetails = async () => {
            if(!isAdmin || !currentAuthorName) return;
            const img = document.getElementById('edit-auth-img').value;
            const bio = document.getElementById('edit-auth-bio').value;
            await setDoc(doc(db, "authors", currentAuthorName), { name: currentAuthorName, img: img, bio: bio });
            showToast("Yazar bilgileri g√ºncellendi ‚úÖ");
            const authorBooks = globalBooks.filter(b => b.author === currentAuthorName);
            openAuthorDetail(currentAuthorName, authorBooks);
        }

        async function fetchAuthorFromWiki(authorName) {
             try {
                let url = `https://tr.wikipedia.org/w/api.php?action=query&format=json&prop=extracts|pageimages&exintro&explaintext&pithumbsize=500&titles=${encodeURIComponent(authorName)}&origin=*`;
                let res = await fetch(url);
                let data = await res.json();
                let pages = data.query.pages;
                let pageId = Object.keys(pages)[0];
                if(pageId === "-1") {
                     url = `https://en.wikipedia.org/w/api.php?action=query&format=json&prop=extracts|pageimages&exintro&explaintext&pithumbsize=500&titles=${encodeURIComponent(authorName)}&origin=*`;
                     res = await fetch(url);
                     data = await res.json();
                     pages = data.query.pages;
                     pageId = Object.keys(pages)[0];
                }
                if(pageId === "-1") return null;
                const page = pages[pageId];
                return { bio: page.extract || "Biyografi bulunamadƒ±.", img: page.thumbnail ? page.thumbnail.source : "" };
             } catch (e) { return null; }
        }

        window.autoFixMissing = async () => {
            if(!isAdmin) return;
            showToast("Eksik taramasƒ± ba≈üladƒ±...");
            const missingBooks = globalBooks.filter(b => !b.cover || !b.desc || b.desc.length < 5);
            for(const b of missingBooks){
                const info = await fetchFromGoogle(`intitle:${b.title}+inauthor:${b.author}`);
                if(info){
                    const u={};
                    if(!b.cover && info.imageLinks) u.cover = info.imageLinks.thumbnail.replace('http:','https:');
                    if((!b.desc || b.desc.length<5) && info.description) u.desc = info.description;
                    if(Object.keys(u).length > 0) await updateDoc(doc(db,"books",b.id),u);
                }
            }
            const uniqueAuthors = [...new Set(globalBooks.map(b => b.author))];
            let authorCount = 0;
            for(const authorName of uniqueAuthors) {
                const currentMeta = authorMeta[authorName];
                const needsUpdate = !currentMeta || !currentMeta.img || currentMeta.img === "";
                if(needsUpdate) {
                    const wikiData = await fetchAuthorFromWiki(authorName);
                    if(wikiData) {
                        let newBio = wikiData.bio;
                        if(currentMeta && currentMeta.bio && currentMeta.bio.length > 10) newBio = currentMeta.bio;
                        await setDoc(doc(db, "authors", authorName), { name: authorName, img: wikiData.img, bio: newBio }, { merge: true });
                        authorCount++;
                    }
                }
            }
            showToast(`Tarama Bitti: ${authorCount} yazar g√ºncellendi.`);
        }

        function listenToUsers() { 
            onSnapshot(collection(db, "users"), (snap) => { 
                const list = document.getElementById('users-list'); 
                list.innerHTML = ""; 
                document.getElementById('count-users').innerText = `Toplam: ${snap.size} Okur`; 
                snap.forEach(d => { 
                    const u = d.data(); 
                    const isSuper = (u.email === SUPER_ADMIN_EMAIL); 
                    const isUserAdmin = (u.role === 'admin'); 
                    const displayTitle = u.displayName || "ƒ∞simsiz Okur"; 
                    let roleLabel="√úye", roleClass=""; 
                    if(isSuper){roleLabel="S√ºper Admin";roleClass="super";}
                    else if(isUserAdmin){roleLabel="Y√∂netici";roleClass="admin";} 
                    let adminControls = ""; 
                    if(isAdmin && !isSuper) { adminControls = `<div style="display:flex;"><button class="btn-user-action" style="background:${isUserAdmin?'#e67e22':'#2ecc71'};" onclick="event.stopPropagation(); toggleUserRole('${d.id}', '${u.role}')">${isUserAdmin ? 'Yetki Al' : 'Y√∂netici Yap'}</button><button class="btn-user-action" style="background:var(--danger);" onclick="event.stopPropagation(); deleteUser('${d.id}')">Sil</button></div>`; } 
                    const div = document.createElement('div'); 
                    div.className = "user-row"; 
                    div.innerHTML = `<div class="user-info"><span style="font-weight:600; font-size:15px; color:${u.displayName ? 'white' : '#ccc'}">${displayTitle}</span> <span class="user-role-badge ${roleClass}">${roleLabel} ${u.isPrivate ? 'üîí' : ''}</span></div>${adminControls}`; 
                    list.appendChild(div); 
                }); 
            }); 
        }
        
        function listenToInteractions() { if(!currentUser)return; const q=query(collection(db,"interactions"),where("uid","==",currentUser.uid)); onSnapshot(q,(snap)=>{ userInteractions={}; snap.forEach(d=>userInteractions[d.data().bookId]=d.data()); applyFilters(); updateProfileStats(); }); }
        function listenToUserComments() { if(!currentUser) return; const q = query(collection(db, "comments"), where("uid", "==", currentUser.uid)); onSnapshot(q, (snap) => { myComments = []; snap.forEach(d => myComments.push({id: d.id, ...d.data()})); myComments.sort((a,b) => (b.date || 0) - (a.date || 0)); document.getElementById('stat-com').innerText = myComments.length; }); }
        
        function renderPendingList() {
            const list = document.getElementById('pending-list');
            if(!list) return;
            list.innerHTML = "";
            if(pendingBooks.length === 0) { list.innerHTML = "<div style='color:#666; font-size:12px; text-align:center;'>Bekleyen yok.</div>"; return; }
            pendingBooks.forEach(b => {
                const div = document.createElement('div');
                div.className = "pending-item";
                div.onclick = () => openBookModal(b); 
                div.innerHTML = `<span class="pending-badge">Onay Bekliyor</span> <span style="font-size:13px; font-weight:600; flex:1;">${b.title}</span> <span style="font-size:11px; color:#aaa;">${b.author}</span>`;
                list.appendChild(div);
            });
        }

        window.applyFilters = () => { const q = document.getElementById('search-input').value.toLowerCase(); const list = globalBooks.filter(b => b.title.toLowerCase().includes(q) || b.author.toLowerCase().includes(q)); list.sort((a,b) => { return sortAsc ? a.title.localeCompare(b.title) : b.title.localeCompare(a.title); }); const container = document.getElementById('book-list'); container.innerHTML = ""; list.forEach(b => container.appendChild(createBookCard(b))); }
        window.toggleSort = () => { sortAsc = !sortAsc; document.getElementById('btn-sort').innerText = sortAsc ? "A-Z" : "Z-A"; applyFilters(); showToast(sortAsc ? "A'dan Z'ye ‚¨áÔ∏è" : "Z'den A'ya ‚¨ÜÔ∏è"); }
        window.goToAuthor = (name) => { const authorBooks = globalBooks.filter(b => b.author === name); openAuthorDetail(name, authorBooks); }
        
        function createBookCard(b) { 
            const i = userInteractions[b.id] || {}; 
            let statusColor = i.status==='read'?'var(--success)':i.status==='want'?'var(--accent)':null; 
            const div = document.createElement('div'); div.className = "book-item"; 
            if(b.isMyPending) div.classList.add('just-added');
            div.onclick = () => openBookModal(b); 
            let ownerBadge = "";
            if (b.isMyPending) { ownerBadge = `<div class="owner-badge pending">‚è≥ ƒ∞NCELENƒ∞YOR</div>`; } 
            else if (b.ownerType === 'library' || !b.ownerType) { ownerBadge = `<div class="owner-badge library">üè´ K√úT√úPHANE</div>`; } 
            else { ownerBadge = `<div class="owner-badge user">üë§ ${b.addedByName || "√úye"}</div>`; }
            let coverHtml = (b.cover && b.cover.length > 5) ? `<img src="${b.cover}">` : `<div class="default-cover">üìö</div>`; 
            div.innerHTML = `${ownerBadge}<div class="book-icon-box">${coverHtml}</div><div class="book-details"><div class="book-title">${b.title}</div><div class="book-author">${b.author}</div></div>${statusColor?`<div class="status-badge show" style="background:${statusColor}"></div>`:''}`; 
            return div; 
        }
        
        // --- YENƒ∞ EƒûLENCELƒ∞ √ñNERƒ∞ Sƒ∞STEMƒ∞ ---
        window.recommendBook = () => { 
            // 1. Okunmamƒ±≈ü kitaplarƒ± filtrele
            const unread = globalBooks.filter(b => { 
                const i = userInteractions[b.id]; 
                return !i || i.status !== 'read'; 
            }); 
            
            if(unread.length === 0) { 
                alert("Tebrikler! K√ºt√ºphanedeki t√ºm kitaplarƒ± okumu≈üsun! üéâ"); 
                return; 
            } 
            
            // 2. Rastgele Se√ß
            const randomBook = unread[Math.floor(Math.random() * unread.length)]; 
            
            // 3. Global deƒüi≈ükene ata ki butonlar √ßalƒ±≈üsƒ±n
            currentBook = randomBook; 
            
            // 4. Modal i√ßeriƒüini doldur
            const container = document.getElementById('fun-book-content');
            const cover = (randomBook.cover && randomBook.cover.length > 5) ? randomBook.cover : "https://cdn-icons-png.flaticon.com/512/3389/3389081.png";
            
            container.innerHTML = `
                <img src="${cover}" class="fun-cover">
                <div class="fun-title">${randomBook.title}</div>
                <div class="fun-author">${randomBook.author}</div>
                <div class="fun-actions">
                    <button class="btn-fun btn-fun-add" onclick="acceptRecommendation()">üîñ Listeme Ekle</button>
                    <button class="btn-fun btn-fun-view" onclick="viewRecommendation()">üîç ƒ∞ncele</button>
                </div>
            `;
            
            // 5. Modalƒ± g√∂ster
            document.getElementById('recommendation-modal').style.display = 'flex';
        }

        window.closeRecommendation = () => {
            document.getElementById('recommendation-modal').style.display = 'none';
        }

        window.acceptRecommendation = async () => {
            await setStatus('want'); // Mevcut setStatus fonksiyonunu kullanƒ±r (currentBook ayarlƒ± olduƒüu i√ßin √ßalƒ±≈üƒ±r)
            closeRecommendation();
            showToast("Harika se√ßim! Listene eklendi. üöÄ");
        }

        window.viewRecommendation = () => {
            closeRecommendation();
            openBookModal(currentBook); // Normal detay sayfasƒ±nƒ± a√ß
        }
        // -------------------------------------

        function requireLogin() { if (!currentUser) { showToast("Bu i≈ülem i√ßin giri≈ü yapmalƒ±sƒ±n üîí"); switchTab('profile'); return true; } return false; }

        window.openBookModal = async (book) => {
            currentBook = book;
            document.getElementById('modal-view-mode').classList.remove('hidden'); document.getElementById('modal-edit-mode').classList.add('hidden'); document.getElementById('modal-edit-auth-mode').classList.add('hidden'); document.getElementById('modal-author-view-mode').classList.add('hidden');
            const isPending = (book.status === 'pending');
            document.getElementById('btn-edit-mode').style.display = (isAdmin || isPending) ? 'block' : 'none'; 
            document.getElementById('btn-edit-mode').innerText = "D√ºzenle";
            document.getElementById('btn-edit-auth-mode').style.display = 'none'; 
            document.getElementById('modal-title').innerText = "Kitap Detayƒ±";
            const i = userInteractions[book.id] || {};
            const snap = await getDocs(query(collection(db, "interactions"), where("bookId", "==", book.id)));
            let r=0, w=0, ratingsSum=0, ratingsCount=0; 
            snap.forEach(d=>{ const v=d.data(); if(v.status==='read')r++; if(v.status==='want')w++; if(v.rating && v.rating > 0) { ratingsSum += v.rating; ratingsCount++; } });
            let avgRating = ratingsCount > 0 ? (ratingsSum / ratingsCount).toFixed(1) : "0.0";
            let ownerInfo = "";
            let claimButton = ""; 
            if(book.ownerType === 'user') {
                ownerInfo = `<div style="background:var(--user-book); color:black; padding:8px; border-radius:6px; font-weight:bold; font-size:12px; display:inline-block; margin-bottom:10px;">üë§ Bu kitap ${book.addedByName} tarafƒ±ndan eklendi.</div>`;
                if(isAdmin) claimButton = `<button onclick="claimBook()" class="btn-main" style="background:var(--library); color:black; margin-bottom:15px; font-weight:bold;">üè´ K√ºt√ºphane Envanterine Al</button>`;
            } else { ownerInfo = `<div style="background:var(--library); color:black; padding:8px; border-radius:6px; font-weight:bold; font-size:12px; display:inline-block; margin-bottom:10px;">üè´ Fiziksel K√ºt√ºphane Envanteri</div>`; }
            let coverDisplay = book.cover ? `<img src="${book.cover}" style="width:120px; height:180px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.5); margin-bottom:15px;">` : `<div style="width:120px; height:180px; border-radius:12px; background:#333; display:flex; align-items:center; justify-content:center; font-size:50px; margin:0 auto 15px;">üìö</div>`;
            document.getElementById('modal-view-mode').innerHTML = `${coverDisplay}<br>${ownerInfo}${claimButton}<h2 style="font-size:20px; margin-bottom:5px;">${book.title} ${isPending ? '<span style="color:orange;font-size:12px;">(Onay Bekliyor)</span>' : ''}</h2><span onclick="goToAuthor('${book.author}')" style="color:var(--accent); font-size:15px; cursor:pointer; text-decoration:underline;">${book.author}</span><div class="minimal-stat-bar"><span>‚úÖ <strong>${r}</strong> Okudu</span><span>üîñ <strong>${w}</strong> Listede</span><span>‚òÖ <strong>${avgRating}</strong> (${ratingsCount})</span></div><div class="star-rating-minimal">${[1,2,3,4,5].map(n=>`<span class="star ${(i.rating||0)>=n?'filled':''}" onclick="setRating(${n})">‚òÖ</span>`).join('')}</div><div class="compact-actions"><button class="btn-compact ${i.status==='read'?'active-read':''}" id="btn-modal-read" onclick="setStatus('read')">‚úÖ Okudum</button><button class="btn-compact ${i.status==='want'?'active-want':''}" id="btn-modal-want" onclick="setStatus('want')">üîñ Listem</button></div><div style="text-align:left; background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin-top:10px;"><h4 style="margin:0 0 5px 0; color:#999; font-size:13px;">√ñzet</h4><p style="color:#ddd; font-size:13px; line-height:1.5;">${book.desc||"√ñzet yok."}</p></div><div style="margin-top:20px; text-align:left;"><h4 style="margin-bottom:10px; font-size:14px;">Yorumlar <span id="comment-count-badge" style="font-size:12px; color:#888;">(0)</span></h4><div id="comments-list">Y√ºkleniyor...</div><div style="display:flex; gap:10px; margin-top:10px;"><input type="text" id="comment-input" class="input-std" placeholder="Yorum..." style="margin:0; height:40px;"><button onclick="sendComment()" class="btn-main" style="margin:0; width:auto; height:40px;">G√∂nder</button></div></div>`;
            document.getElementById('full-modal').style.display = 'block'; loadComments(book.id);
        }

        window.claimBook = async () => { if(!isAdmin) return; if(confirm("Bu kitabƒ± fiziksel k√ºt√ºphane envanterine almak istiyor musun?")) { await updateDoc(doc(db, "books", currentBook.id), { ownerType: 'library' }); currentBook.ownerType = 'library'; openBookModal(currentBook); showToast("Kitap envantere alƒ±ndƒ±! üè´"); } }
        
        window.setStatus = async (s) => { 
            if(requireLogin()) return; 
            const current = userInteractions[currentBook.id] || {}; 
            const newStatus = (current.status === s) ? null : s; 
            userInteractions[currentBook.id] = { ...current, status: newStatus }; 
            document.getElementById('btn-modal-read').classList.toggle('active-read', newStatus === 'read'); 
            document.getElementById('btn-modal-want').classList.toggle('active-want', newStatus === 'want'); 
            updateProfileStats(); 
            const ref = doc(db, "interactions", `${currentUser.uid}_${currentBook.id}`); 
            await setDoc(ref, { uid: currentUser.uid, bookId: currentBook.id, status: newStatus, rating: current.rating || 0 }, { merge: true }); 
        }

        window.setRating = async (r) => { if(requireLogin()) return; const current = userInteractions[currentBook.id] || {}; userInteractions[currentBook.id] = { ...current, rating: r }; const stars = document.querySelectorAll('.star'); stars.forEach((star, index) => star.classList.toggle('filled', index < r)); const ref = doc(db, "interactions", `${currentUser.uid}_${currentBook.id}`); await setDoc(ref, { uid: currentUser.uid, bookId: currentBook.id, rating: r }, { merge: true }); }
        function loadComments(bid) { const l=document.getElementById('comments-list'); if(!l) return; const q=query(collection(db,"comments"),where("bookId","==",bid)); onSnapshot(q,(s)=>{ l.innerHTML=""; document.getElementById('comment-count-badge').innerText = `(${s.size})`; if(s.empty){ l.innerHTML="<div style='color:#666;font-size:12px;'>Yorum yok.</div>"; return;} const comments = []; s.forEach(d => comments.push({id: d.id, ...d.data()})); comments.sort((a,b) => (b.date || 0) - (a.date || 0)); comments.forEach(c=>{ const isOwner = (currentUser && c.uid === currentUser.uid); const canDelete = isOwner || isAdmin; const delBtn = canDelete ? `<div class="comment-del" onclick="deleteComment('${c.id}')">üóëÔ∏è</div>` : ''; const div = document.createElement('div'); div.className = "comment-row"; div.innerHTML = `<div class="comment-user">${c.userName}</div><div class="comment-text">${c.text}</div>${delBtn}`; l.appendChild(div); }); }); }
        window.deleteComment = async (id) => { if(confirm("Yorumu silmek istiyor musunuz?")) { await deleteDoc(doc(db, "comments", id)); showToast("Yorum silindi"); } }
        window.sendComment=async()=>{ if(requireLogin()) return; const t=document.getElementById('comment-input').value;if(!t)return;await addDoc(collection(db,"comments"),{bookId:currentBook.id,text:t,userName:currentUser.displayName||"Okur",uid:currentUser.uid,date:Date.now()});document.getElementById('comment-input').value=""; }
        
        window.filterProfile = (type) => { 
            document.querySelectorAll('.profile-filter-btn').forEach(btn => btn.classList.remove('active-filter'));
            const activeBtn = document.getElementById(`btn-filter-${type}`); if(activeBtn) activeBtn.classList.add('active-filter');
            const list = document.getElementById('profile-list'); list.innerHTML = ""; 
            if (type === 'comments') { if (myComments.length === 0) { list.innerHTML = "<div style='text-align:center;color:#666;padding:20px;'>Hen√ºz yorum yapmadƒ±n.</div>"; return; } myComments.forEach(c => { const book = globalBooks.find(b => b.id === c.bookId); if(!book) return; const date = new Date(c.date).toLocaleDateString(); const div = document.createElement('div'); div.className = "my-comment-card"; div.onclick = () => openBookModal(book); const cover = (book.cover && book.cover.length > 5) ? `<img src="${book.cover}" class="my-comment-cover">` : `<div class="my-comment-cover" style="background:#333;display:flex;align-items:center;justify-content:center;">üìö</div>`; div.innerHTML = `${cover}<div class="my-comment-info"><div class="my-comment-book">${book.title}</div><div class="my-comment-date">${date}</div><div class="my-comment-body">"${c.text}"</div></div>`; list.appendChild(div); }); return; } if (type === 'added') { const addedBooks = globalBooks.filter(b => b.addedBy === currentUser.uid); if (addedBooks.length === 0) { list.innerHTML = "<div style='text-align:center;color:#666;padding:20px;'>Hen√ºz kitap eklemedin.</div>"; return; } addedBooks.forEach(b => list.appendChild(createBookCard(b))); return; } const ids = Object.keys(userInteractions).filter(id => { if(type==='read') return userInteractions[id].status==='read'; if(type==='want') return userInteractions[id].status==='want'; }); if(ids.length === 0) list.innerHTML = "<div style='text-align:center;color:#666;padding:20px;'>Liste bo≈ü.</div>"; ids.forEach(id => { const b = globalBooks.find(x => x.id === id); if(b) list.appendChild(createBookCard(b)); }); 
        }
        
        async function fetchFromGoogle(q) { try{const r=await fetch(`https://www.googleapis.com/books/v1/volumes?q=${q}&maxResults=1`);const d=await r.json();return (d.items&&d.items.length>0)?d.items[0].volumeInfo:null;}catch(e){return null;} }
        window.fetchByISBN=async()=>{const i=document.getElementById('isbn-input').value;if(!i)return showToast("ISBN girin");showToast("Aranƒ±yor...");const info=await fetchFromGoogle(`isbn:${i}`);if(info){document.getElementById('add-title').value=info.title;document.getElementById('add-author').value=info.authors?info.authors[0]:'';document.getElementById('add-desc').value=info.description||'';if(info.imageLinks)document.getElementById('add-cover').value=info.imageLinks.thumbnail.replace('http:','https:');showToast("Bulundu ‚ú®");}else showToast("Bulunamadƒ± ‚ùå");}
        window.findCoverFromText=async()=>{const t=document.getElementById('add-title').value;const a=document.getElementById('add-author').value;if(!t)return showToast("ƒ∞sim girin");showToast("Aranƒ±yor...");const info=await fetchFromGoogle(`intitle:${t}+inauthor:${a}`);if(info&&info.imageLinks){document.getElementById('add-cover').value=info.imageLinks.thumbnail.replace('http:','https:');showToast("Kapak bulundu üñºÔ∏è");}else showToast("Bulunamadƒ±");}
        window.adminAddBook=async()=>{ if(!currentUser) { showToast("Giri≈ü yapmalƒ±sƒ±n!"); switchTab('profile'); return; } const t=document.getElementById('add-title').value; const a=document.getElementById('add-author').value; let c=document.getElementById('add-cover').value; const d=document.getElementById('add-desc').value; if(!t||!a) return showToast("Eksik bilgi!"); if(!c){ showToast("Kapak aranƒ±yor..."); const info=await fetchFromGoogle(`intitle:${t}+inauthor:${a}`); if(info&&info.imageLinks) c=info.imageLinks.thumbnail.replace('http:','https:'); } const status = isAdmin ? 'active' : 'pending'; const ownerType = isAdmin ? 'library' : 'user'; await addDoc(collection(db,"books"),{ title:t, author:a, cover:c, desc:d, status:status, ownerType: ownerType, addedBy:currentUser.uid, addedByName: currentUser.displayName || "√úye" }); if(isAdmin) showToast("Yayƒ±nlandƒ± (K√ºt√ºphane Envanteri) ‚úÖ"); else showToast("Onaya G√∂nderildi (√úye Kitabƒ±) ‚è≥"); document.getElementById('add-title').value="";document.getElementById('add-author').value="";document.getElementById('add-cover').value="";document.getElementById('add-desc').value=""; }
        window.adminDeleteBook=async()=>{if(confirm("Silmek istiyor musun?")){await deleteDoc(doc(db,"books",currentBook.id));closeFullModal();showToast("Silindi");}}
        window.toggleEditMode = () => { 
            const view = document.getElementById('modal-view-mode'); 
            const edit = document.getElementById('modal-edit-mode'); 
            
            if(view.classList.contains('hidden')) { 
                // G√∂r√ºnt√ºleme moduna d√∂n
                view.classList.remove('hidden'); 
                edit.classList.add('hidden'); 
                document.getElementById('btn-edit-mode').innerText="D√ºzenle"; 
            } else { 
                // D√ºzenleme moduna gir
                view.classList.add('hidden'); 
                edit.classList.remove('hidden'); 
                document.getElementById('btn-edit-mode').innerText="ƒ∞ptal"; 
                
                // Formu doldur
                document.getElementById('edit-title').value = currentBook.title; 
                document.getElementById('edit-author').value = currentBook.author; 
                document.getElementById('edit-cover').value = currentBook.cover||""; 
                document.getElementById('edit-desc').value = currentBook.desc||""; 
                
                // --- ƒ∞≈ûTE BU KISIM EKSƒ∞KTƒ∞ ---
                // Eƒüer kitap 'pending' (bekleyen) ise Onay butonunu g√∂ster
                const isPending = (currentBook.status === 'pending');
                document.getElementById('btn-approve-publish').style.display = isPending ? 'block' : 'none';
                document.getElementById('edit-mode-warning').style.display = isPending ? 'block' : 'none';
            } 
        }
        window.saveEditedBook = async () => { if(!isAdmin)return; const d={title:document.getElementById('edit-title').value, author:document.getElementById('edit-author').value, cover:document.getElementById('edit-cover').value, desc:document.getElementById('edit-desc').value}; await updateDoc(doc(db,"books",currentBook.id),d); showToast("G√ºncellendi ‚úÖ"); openBookModal({id:currentBook.id, ...d, status: currentBook.status, ownerType: currentBook.ownerType, addedByName: currentBook.addedByName}); }
        window.approveBook = async () => { if(!isAdmin) return; const d={ title:document.getElementById('edit-title').value, author:document.getElementById('edit-author').value, cover:document.getElementById('edit-cover').value, desc:document.getElementById('edit-desc').value, status: 'active' }; await updateDoc(doc(db,"books",currentBook.id), d); showToast("Kitap Yayƒ±nlandƒ±! üéâ"); closeFullModal(); }
        window.toggleUserRole = async (uid, currentRole) => { if(!isAdmin) return; const newRole = currentRole === 'admin' ? 'user' : 'admin'; if(confirm(`Yetkiyi deƒüi≈ütirmek istiyor musun?`)) await updateDoc(doc(db, "users", uid), { role: newRole }); }
        window.deleteUser = async (uid) => { if(!isAdmin) return; if(confirm("Kullanƒ±cƒ±yƒ± silmek istediƒüine emin misin?")) await deleteDoc(doc(db, "users", uid)); }
        window.viewMessages = async () => { if(!isAdmin) return; document.getElementById('modal-view-mode').classList.remove('hidden'); document.getElementById('modal-edit-mode').classList.add('hidden'); document.getElementById('full-modal').style.display = 'block'; document.getElementById('modal-title').innerText = "Gelen Mesajlar"; const listDiv = document.getElementById('modal-view-mode'); listDiv.innerHTML = "Y√ºkleniyor..."; const q = query(collection(db, "messages"), orderBy("date", "desc")); const snap = await getDocs(q); if(snap.empty) { listDiv.innerHTML = "Mesaj yok."; return; } let html = ""; snap.forEach(d => { const m = d.data(); const date = new Date(m.date).toLocaleDateString(); html += `<div class="msg-item"><div class="msg-header"><span>${m.email}</span><span>${date}</span></div><div>${m.text}</div></div>`; }); listDiv.innerHTML = html; }
        
        window.switchTab=(t)=>{ 
            // OKURLAR SEKME KORUMASI: Admin deƒüilse 'users' sayfasƒ±na gidemez
            if(t==='users' && !isAdmin) return showToast("Bu alan sadece y√∂neticilere √∂zeldir.");
            if((t==='profile' || t==='users' || t==='add') && !currentUser && t!=='library' && t!=='authors') { document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById('tab-profile').classList.add('active'); document.querySelectorAll('.content-area').forEach(e=>e.classList.add('hidden')); document.getElementById('page-auth').classList.remove('hidden'); return; } 
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); document.querySelectorAll('.content-area').forEach(e=>e.classList.add('hidden')); document.getElementById('page-'+t).classList.remove('hidden'); if(t==='profile') filterProfile('read'); 
        }
        window.closeFullModal = () => document.getElementById('full-modal').style.display = 'none';
        
        window.showToast=(m)=>{
            const t=document.getElementById('toast-container');
            t.innerHTML = ''; // √ñnceki mesajƒ± temizle
            const e=document.createElement('div');
            e.className='toast';
            e.innerText=m;
            t.appendChild(e);
            setTimeout(()=>e.classList.add('show'),50);
            setTimeout(()=>{
                e.classList.remove('show');
                setTimeout(()=>e.remove(),300)
            },3000);
        }

        function updateProfileStats() { const validIds = globalBooks.map(b => b.id); const v = Object.values(userInteractions).filter(i => validIds.includes(i.bookId)); document.getElementById('stat-read').innerText = v.filter(i=>i.status==='read').length; document.getElementById('stat-want').innerText = v.filter(i=>i.status==='want').length; if(currentUser) { const addedCount = globalBooks.filter(b => b.addedBy === currentUser.uid).length; document.getElementById('stat-added').innerText = addedCount; } else { document.getElementById('stat-added').innerText = 0; } }
    </script>
</body>
</html>

